<div 
  [class.rotate-2]="isDragging()"
  [class.scale-105]="isDragging()"
  [class.opacity-90]="isDragging()"
  (click)="onCardClick($event)"
  class="group cursor-pointer rounded-lg border border-border bg-card p-4 shadow-soft transition-smooth hover:shadow-medium hover:border-primary/20 relative">
  
  <!-- Hidden file input -->
  <input
    #fileInput
    type="file"
    multiple
    class="hidden"
    (change)="handleFileSelect($event)"
    (click)="$event.stopPropagation()" />
  
  <!-- Quick actions on hover -->
  <div class="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity z-10">
    <!-- Comment button with popover -->
    <div class="relative">
      <button
        type="button"
        (click)="toggleCommentPopover($event)"
        class="h-7 w-7 rounded bg-secondary shadow-sm flex items-center justify-center hover:bg-secondary/80 transition-colors">
        <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
      </button>
      
      <!-- Comment popover -->
      @if (commentOpen()) {
        <div 
          class="absolute top-full right-0 mt-1 w-64 p-2 bg-card border border-border rounded-lg shadow-medium z-50"
          (click)="$event.stopPropagation()">
          <div class="space-y-2">
            <textarea
              [(ngModel)]="commentText"
              (keydown)="onCommentKeyDown($event)"
              placeholder="Add a quick comment..."
              rows="2"
              class="w-full rounded border border-input bg-background px-2 py-1.5 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary">
            </textarea>
            <button
              type="button"
              (click)="handleAddComment($event)"
              [disabled]="!commentText().trim()"
              class="w-full h-8 rounded bg-primary text-primary-foreground text-sm font-medium hover:bg-primary/90 disabled:opacity-60 flex items-center justify-center gap-2">
              <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
              </svg>
              Add Comment
            </button>
          </div>
        </div>
      }
    </div>
    
    <!-- Attach button -->
    <button
      type="button"
      (click)="handleAttachClick($event)"
      class="h-7 w-7 rounded bg-secondary shadow-sm flex items-center justify-center hover:bg-secondary/80 transition-colors">
      <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
      </svg>
    </button>
  </div>
  
  <!-- Project Badge -->
  @if (showProject() && project()) {
    <div class="flex items-center gap-1.5 mb-2">
      <div 
        class="h-2 w-2 rounded-full"
        [style.background-color]="project()!.color">
      </div>
      <span class="text-[10px] font-medium text-muted-foreground uppercase tracking-wide">
        {{ project()!.name }}
      </span>
    </div>
  }
  
  <!-- Labels -->
  @if (hasLabels()) {
    <div class="flex flex-wrap gap-1 mb-2">
      @for (label of task().labels || []; track label.id) {
        <span
          [style.background-color]="label.color"
          class="inline-block rounded-full px-1.5 py-0 text-[10px] font-medium text-white h-4">
          {{ label.name }}
        </span>
      }
    </div>
  }
  
  <!-- Header: Title & Priority -->
  <div class="mb-3 flex items-start justify-between gap-2 pr-16 group-hover:pr-20">
    <h3 class="text-sm font-medium text-card-foreground line-clamp-2 group-hover:text-primary transition-colors">
      {{ task().title }}
    </h3>
    <app-priority-badge [priority]="task().priority" [showLabel]="false" />
  </div>
  
  <!-- Description -->
  @if (task().description) {
    <p class="mb-3 text-xs text-muted-foreground line-clamp-2">
      {{ task().description }}
    </p>
  }
  
  <!-- Subtasks Progress -->
  @if (hasSubtasks()) {
    <div class="mb-3 flex items-center gap-2 text-xs text-muted-foreground">
      <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
      </svg>
      <span>
        {{ completedSubtasks() }}/{{ task().subtasks?.length || 0 }} subtasks
      </span>
    </div>
  }
  
  <!-- Footer -->
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <!-- Due Date -->
      <div 
        [class]="dueDateClass()"
        class="flex items-center gap-1.5 text-xs">
        <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        <span>{{ formattedDueDate() }}</span>
      </div>
      
      <!-- Comments count -->
      @if (hasComments()) {
        <div class="flex items-center gap-1 text-xs text-muted-foreground">
          <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          <span>{{ task().comments?.length || 0 }}</span>
        </div>
      }
      
      <!-- Attachments count -->
      @if (hasAttachments()) {
        <div class="flex items-center gap-1 text-xs text-muted-foreground">
          <svg class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" />
          </svg>
          <span>{{ task().attachments?.length || 0 }}</span>
        </div>
      }
    </div>
    
  <!-- Assignees -->
  <div class="flex items-center -space-x-1">
    @if (firstAssignee()) {
      <div class="h-6 w-6 rounded-full border-2 border-card bg-primary/10 flex items-center justify-center text-[10px] font-medium">
        {{ assigneeInitials() }}
      </div>
    } @else {
      <div class="h-6 w-6 rounded-full border-2 border-card bg-muted flex items-center justify-center text-[10px] font-medium text-muted-foreground">
        U
      </div>
    }
    
    @if (additionalAssigneesCount() > 0) {
      <div class="h-6 w-6 rounded-full border-2 border-card bg-secondary flex items-center justify-center text-[10px] font-medium">
        +{{ additionalAssigneesCount() }}
      </div>
    }
  </div>
</div>